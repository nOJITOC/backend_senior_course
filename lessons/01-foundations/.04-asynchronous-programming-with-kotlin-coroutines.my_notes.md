### Мои заметки по уроку: Асинхронное программирование с Kotlin Coroutines

**Цель:** Углубить понимание асинхронного программирования с помощью Kotlin Coroutines в контексте Ktor-бэкенда. Объяснить ключевые концепции (suspend, Dispatchers, builders, Structured Concurrency) и их практическое применение для построения высокопроизводительных, масштабируемых и надежных сервисов.

**Ключевые концепции:**

1.  **Coroutines (Корутины):**
    *   Легковесные "нити" выполнения.
    *   Приостанавливаются и возобновляются, не блокируя поток.
    *   Экономят ресурсы по сравнению с потоками ОС.
2.  **`suspend` функции:**
    *   Функции, которые могут быть приостановлены.
    *   Вызываются только из других `suspend` функций или корутин.
    *   Пример: `delay()`, сетевые вызовы, операции с БД.
3.  **Диспетчеры (Dispatchers):**
    *   `Dispatchers.Default`: CPU-bound операции (сложные вычисления).
    *   `Dispatchers.IO`: IO-bound операции (сеть, диск, БД). **Важен для Ktor!**
    *   `Dispatchers.Main`: UI-обновления (неактуально для бэкенда).
    *   `Dispatchers.Unconfined`: Специфические сценарии, не для общего использования.
4.  **Билдеры корутин (Coroutine Builders):**
    *   `launch`: "Fire-and-forget", возвращает `Job`.
    *   `async`: Возвращает `Deferred<T>`, результат можно получить через `await()`. Используется для параллельного выполнения задач с ожиданием результата.
5.  **Структурированный параллелизм (Structured Concurrency):**
    *   Корутины имеют иерархию (родитель-потомок).
    *   Отмена родительской корутины приводит к отмене всех дочерних.
    *   `CoroutineScope`: Определяет жизненный цикл корутин.
    *   **В Ktor:** Каждый HTTP-запрос автоматически получает свой `CoroutineScope`, что обеспечивает автоматическую отмену всех связанных операций, если запрос отменяется клиентом. Это ключевое преимущество для предотвращения утечек ресурсов.

**Преимущества в Ktor:**

*   **Производительность и масштабируемость:** Обработка тысяч запросов на небольшом количестве потоков.
*   **Простота кода:** Асинхронный код выглядит синхронным.
*   **Надежность:** Автоматическая отмена и управление ошибками благодаря Structured Concurrency.

**План урока:**
1.  **Теоретический блок:** Что такое корутины, `suspend`, Dispatchers, билдеры, Structured Concurrency. Преимущества в Ktor.
2.  **Вопрос:** Как Structured Concurrency в Ktor помогает предотвратить "зависшие" запросы и утечки ресурсов.
3.  **Практическое задание:** Модифицировать Ktor-приложение для использования `async`/`await` или `withContext` для симуляции долгой операции.
4.  **Теоретический блок:** Обработка ошибок в корутинах (try-catch, CoroutineExceptionHandler).
5.  **Вопрос:** Применение обработки ошибок в Ktor-корутинах.
6.  **Практическое задание:** Добавить обработку ошибок в Ktor-эндпоинт.

**Ресурсы для исследования:**
*   Официальная документация Kotlin Coroutines.
*   Статьи о Ktor и корутинах.
*   Примеры использования `withContext` и `async` для IO-операций.
